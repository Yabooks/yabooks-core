<!DOCTYPE HTML>
<html>
    <head>
        <script type="text/javascript" src="/js/axios/axios.min.js"></script>
        <script type="text/javascript" src="/js/vue/vue.js"></script>
    </head>
    <body>
        <main>
            <div id="preview">
                <div class="scaled" :style="{ transform: `scale(${zoom})` }">
                    <template class="page" v-for="page in pages" :key="page">
                        <img :src="pagePreviewSrc(page)" />
                    </template>
                </div>
            </div>
            <div id="toolbar">
                <button class="toolButton" @click="chooseTool('pencil')">
                    &#x270F;&#xFE0F;
                </button>
                <button class="toolButton" @click="chooseTool('eraser')">
                    &#x1F5D1;&#xFE0F;
                </button>
                <button class="toolButton" @click="adaptZoomLevel(-.1)" :disabled="zoom <= .2">
                    -
                </button>
                <button class="toolButton" @click="adaptZoomLevel(.1)" :disabled="zoom > 1.5">
                    +
                </button>
                <button class="toolButton" @click="downloadDocument()">
                    &#x1F4E9;
                </button>
            </div>
        </main>
        <style type="text/css">
            #preview {
                width: 100%;
                text-align: center;
            }
            #preview .scaled {
                /* TODO */
            }
            #toolbar {
                position: fixed;
                bottom: 10px;
                left: 10px;
                height: 40px;
                width: calc(100% - 20px);
                background: gray;
                border-radius: 20px;
                text-align: center;
            }
        </style>
        <script type="text/javascript">
            Vue.createApp(
            {
                mounted()
                {
                    const reqParams = new URLSearchParams(self.location.search);

                    if(reqParams.get("doc_id"))
                        this.loadDocument(reqParams.get("doc_id"));

                    if(reqParams.get("transparent"))
                        this.transparent = true;

                    if(reqParams.get("websocket"))
                        ;// TODO
                },

                data()
                {
                    return {
                        _id: null,
                        annotations_supported: false,
                        annotations: [], // [ [ { points: [ {x,y} ], color: [r,g,b], opacity, lineWidth } ] ]
                        pages: 0,
                        zoom: .5
                    };
                },

                methods:
                {
                    async loadDocument(doc_id)
                    {
                        let doc = await axios.get(`/api/v1/documents/${doc_id}/preview`);
                        this._id = doc_id;
                        this.annotations_supported = doc.data.annotations_supported;
                        this.annotations = doc.data.annotations ?? [];
                        this.pages = doc.data.pages;
                        this.$forceUpdate();
                    },

                    downloadDocument()
                    {
                        self.location = `/api/v1/documents/${this._id}/binary`;
                    },

                    pagePreviewSrc(page)
                    {
                        return `/api/v1/documents/${this._id}/preview/pages/${page}`;
                    },

                    adaptZoomLevel(change)
                    {
                        this.zoom += change;
                    },

                    chooseTool(tool)
                    {
                        // TODO
                    }
                }
            }).mount("main");
        </script>
    </body>
</html>